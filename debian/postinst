#!/bin/sh
# postinst script for cloudbook
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

install_icon()
{
    xdg-icon-resource install "$@" >/dev/null 2>&1
}

InstallIcons()
{
    install_dir="/usr/share/icons/hicolor"

    for icon_size in 16 20 22 24 32 36 48 64 96 128 192; do
        install_icon --noupdate --novendor --context mimetypes --size $icon_size "$install_dir/${icon_size}x${icon_size}/mimetypes/cloudbook-filetype.png" 'application-cloudbook'
    done
}




hardlinks="icudtl.dat nw nw.pak"
links="libffmpegsumo.so locales"




case "$1" in
    configure)

	InstallIcons
	xdg-icon-resource forceupdate >/dev/null 2>&1

	#creates asociation between mime file and program
	xdg-mime default cloudbook.desktop application/cloudbook
	#update databases
	update-desktop-database
	update-mime-database /usr/share/mime

	set +e
	nwjspath=`dirname $(dpkg -L nwjs0.12 | grep nw$ )`/
	nwjsdevice=$(df $nwjspath | awk '/^\/dev/ {print $1}')
	apppath="/usr/share/cloudbook/"
	appdevice=$(df $apppath | awk '/^\/dev/ {print $1}')
	for filetolink in links; do
		ln -s ${nwjspath}${filetolink} ${apppath}${filetolink}
	done
	if [ "$nwjsdevice" = "$appdevice" ]
	then
		# Same device. Hard link files
		for filetolink in $hardlinks; do
			ln ${nwjspath}${filetolink} ${apppath}${filetolink}
		done	
	else
		# Different device. Copy files
		for filetocopy in $hardlinks; do
                        cp ${nwjspath}${filetocopy} ${apppath}${filetocopy}
                done
	fi
	mv ${apppath}nw ${apppath}cloudbook
	chmod +x ${apppath}cloudbook
	set -e

	#

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
